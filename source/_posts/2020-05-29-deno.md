---
title: deno
date: 2020-05-29 16:18:55
tags:
- deno
categories:
- nodejs
---
# 0. Attention

æœ¬æ–‡ä¸ºä¸ªäººç¿»è¯‘ï¼Œå­¦ä¹ è¾“å‡ºï¼Œä»…ä¾›å‚è€ƒï¼Œæ¬¢è¿æŒ‡å‡ºç†è§£ä¸è¶³ä¹‹å¤„

# 1. Introduction

# 2.Getting Started

## 2.1 Installation

## 2.2 Setup your environment

## 2.3 First steps

### 2.3.1 helloworld

```javascript
console.log("Welcome to Deno ğŸ¦•");
deno run https://deno.land/std/examples/welcome.ts
```

### 2.3.2 Make http request

```javascript
const url = Deno.args[0];//get url
const res = await fetch(url);//await response -->res

const body = new Uint8Array(await res.arrayBuffer());//parse body as ArrayBuffer and convert into Uint8Array
await Deno.stdout.write(body);//write body --> stdout

//run
//wrong cause no permision
deno run https://deno.land/std/examples/curl.ts https://example.com
//right
deno run --allow-net=example.com https://deno.land/std/examples/curl.ts https://example.com
```

### 2.3.3 reading a file

denoæä¾›éæºè‡ªç½‘ç»œçš„apiï¼Œè¿™äº›å¯ä»¥åœ¨denoå…¨å±€è°ƒç”¨ï¼Œç”±äºç›®å‰æ²¡æœ‰webæ ‡å‡†ï¼Œæ‰€ä»¥denoå°±è‡ªå·±åšäº†ä¸€å¥—æ ‡å‡†ï¼Œä»¥ä¸‹ç¤ºä¾‹filename-->open-->print

```javascript
const filenames = Deno.args;
for (const filename of filenames) {
  const file = await Deno.open(filename);
  await Deno.copy(file, Deno.stdout);
  file.close();
}
```

ä½¿ç”¨äº†**kernel->user->kernel**çš„æ–¹å¼copyï¼Œä¿è¯æ•°æ®**ä¸€è‡´æ€§**

é¿å…äº†å¸¸è§çš„4æ¬¡æ‹·è´

1. ç£ç›˜-----DMA---->é¡µç¼“å­˜ï¼ˆkernelï¼‰
2. é¡µç¼“å­˜(kernel)-->ç”¨æˆ·ç¼“å­˜ï¼ˆuserï¼‰
3. ç”¨æˆ·ç¼“å­˜ï¼ˆuserï¼‰-->socketç¼“å†²åŒºï¼ˆkernelï¼‰
4. Socket(kernel)---DMA copy--->network

ç»è¿‡å¤šæ¬¡æ‹·è´ï¼Œç¼“å­˜æ•°æ®å¯èƒ½è¢«ä¿®æ”¹ï¼Œ**å¯¼è‡´å’ŒåŸæ–‡ä»¶æ•°æ®ä¸ä¸€è‡´**

```shell
deno run --allow-read https://deno.land/std/examples/cat.ts /etc/passwd
```

### 2.3.4 tcp server

```javascript
const hostname = "0.0.0.0";
const port = 8080;
const listener = Deno.listen({ hostname, port });
console.log(`Listening on ${hostname}:${port}`);
for await (const conn of listener) {
  Deno.copy(conn, conn);
}
```

æœªç»å…è®¸ä¸å¯è®¿é—®ç½‘ç»œï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™æ·»åŠ --allow-net

```shell
deno run --allow-net https://deno.land/std/examples/echo_server.ts
//shell netcat(nc)
nc localhost 8080
hello world//input
```

## 2.4 Permissions

denoæ‹¥æœ‰ä¸¥æ ¼çš„æƒé™ç®¡ç†ï¼Œé™¤éä½ å£°æ˜ï¼Œå¦åˆ™denoä¸ä¼šæœ‰file network enviromentæƒé™ï¼Œèµ‹äºˆåªè¯»æƒé™å°±ä¸ä¼šæœ‰è¯»å†™æƒé™

### 2.4.1 Permissions list

- **-A, --allow-all** Allow all permissions. This disables all security.
- **--allow-env** Allow environment access for things like getting and setting of environment variables.
- **--allow-hrtime** Allow high resolution time measurement. High resolution time can be used in timing attacks and fingerprinting.
- **--allow-net=\<allow-net>** Allow network access. You can specify an optional, comma separated list of domains to provide a whitelist of allowed domains.
- **--allow-plugin** Allow loading plugins. Please note that --allow-plugin is an unstable feature.
- **--allow-read=\<allow-read>** Allow file system read access. You can specify an optional, comma separated list of directories or files to provide a whitelist of allowed file system access.
- **--allow-run** Allow running subprocesses. Be aware that subprocesses are not run in a sandbox and therefore do not have the same security restrictions as the deno process. Therefore, use with caution.
- **--allow-write=\<allow-write>** Allow file system write access. You can specify an optional, comma separated list of directories or files to provide a whitelist of allowed file system access.

### 2.4.2 Permission whitelist

é€šè¿‡ç™½åå•ï¼Œå®ç°æ›´é«˜ç²’åº¦çš„æƒé™æ§åˆ¶

ç¤ºä¾‹ç»™äºˆ/usræƒé™ï¼Œä½†è®¿é—®/etc

```shell
$ deno run --allow-read=/usr https://deno.land/std/examples/cat.ts /etc/passwd
error: Uncaught PermissionDenied: read access to "/etc/passwd", run again with the --allow-read flag
â–º $deno$/dispatch_json.ts:40:11
    at DenoError ($deno$/errors.ts:20:5)
    ...
    
//yes    
$ deno run --allow-read=/etc https://deno.land/std/examples/cat.ts /etc/passwd
```

### 2.4.3 Network access

```javascript
const result = await fetch("https://deno.land/");

//run
$ deno run --allow-net=github.com,deno.land fetch.ts//failed
$
```

å¦‚æœfetch.tså°è¯•ä¸åˆ«çš„domainå»ºç«‹è¿æ¥ï¼Œprocesså°†ä¼šå¤±è´¥ï¼Œä½¿ç”¨` deno run --allow-net fetch.ts`åˆ™å¯ä»¥

## 2.5 Using TS

å¤©ç”Ÿæ”¯æŒJS,TSï¼Œéœ€è¦å¼•å…¥æ¨¡å—æ‹“å±•ï¼Œä½¿ç”¨æ–‡ä»¶ï¼Œæˆ–è€…urlè¿›è¡Œå¯¼å…¥

```javascript
import { Response } from "https://deno.land/std@0.53.0/http/server.ts";
import { queue } from "./collections.ts";
```

### 2.5.1 Using external type definitions

å¼€ç®±å³ç”¨çš„TSç¼–è¯‘å™¨ï¼Œä¹Ÿä¾é æ— æ‰©å±•æ¨¡å—(extension-less modules)ï¼Œnodeæ¨¡å—è§£æé€»è¾‘(module resolution logic)æ¥å®ç°å°†ç±»å‹ï¼ˆtpyesï¼‰åº”ç”¨äºJSæ¨¡å—ï¼Œä¸ºäº†ç»™TSä¸JSå»ºç«‹æ¡¥æ¢ï¼Œæ”¯æŒä¸‰ç§å¼•ç”¨ç±»å‹å®šä¹‰æ–‡ä»¶çš„æ–¹å¼

- compiler hint

- Triple-slash reference directive

- #### X-TypeScript-Types custom header

Compiler hint ï¼šå½“ä½ çŸ¥é“æ–‡ä»¶ä½ç½®æ—¶å€™å¼•ç”¨,denoç¼–è¯‘å™¨ä¼šå¤¹åœ¨foo.d.tsè€Œä¸æ˜¯foo.js

å½“è¿è¡Œæ—¶ï¼ŒDenoä¼šä¸€ç›´åŠ è½½foo.js

[ä¸å…¨å¾…è¡¥å……](https://deno.land/manual/getting_started/typescript#compiler-hint)

```typescript
// @deno-types="./foo.d.ts"
import * as foo from "./foo.js";
```



ä¸æ˜¯æ‰€æœ‰å®šä¹‰éƒ½æ”¯æŒï¼šdenoä¼šåŠ è½½*.d.tsæ–‡ä»¶ï¼Œä½†ä¸æ˜¯æ‰€æœ‰æ–‡ä»¶éƒ½æ”¯æŒï¼Œå¦‚è®¿é—®:`./node_modules/@types/node/index.d.ts`



ä¸ºä»€ä¹ˆTSæ–‡ä»¶ä¸­ä¸ä½¿ç”¨triple-slash type reference

å¦‚æœä½¿ç”¨ï¼Œå¹²æ‰°TSç¼–è¯‘å™¨çš„è¡Œä¸ºï¼ŒDenoå°½åœ¨JSå’ŒJSXæ–‡ä»¶ä¸­æŸ¥æ‰¾æŒ‡ä»¤



### 2.5.2 Custom TypeScript Compiler Options

Deno é»˜è®¤å¼€å§‹ä¸¥æ ¼æ¨¡å¼ï¼Œä½¿ç”¨`tsconfig.ts`æ¥é…ç½®ï¼Œéœ€è¦é€šè¿‡-cæ¥å‘Šè¯‰denoé…ç½®æ–‡ä»¶`deno run -c tsconfig.json mod.ts`

```json
//default optins
{
  "compilerOptions": {
    "allowJs": false,
    "allowUmdGlobalAccess": false,
    "allowUnreachableCode": false,
    "allowUnusedLabels": false,
    "alwaysStrict": true,
    "assumeChangesOnlyAffectDirectDependencies": false,
    "checkJs": false,
    "disableSizeLimit": false,
    "generateCpuProfile": "profile.cpuprofile",
    "jsx": "react",
    "jsxFactory": "React.createElement",
    "lib": [],
    "noFallthroughCasesInSwitch": false,
    "noImplicitAny": true,
    "noImplicitReturns": true,
    "noImplicitThis": true,
    "noImplicitUseStrict": false,
    "noStrictGenericChecks": false,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "preserveConstEnums": false,
    "removeComments": false,
    "resolveJsonModule": true,
    "strict": true,
    "strictBindCallApply": true,
    "strictFunctionTypes": true,
    "strictNullChecks": true,
    "strictPropertyInitialization": true,
    "suppressExcessPropertyErrors": false,
    "suppressImplicitAnyIndexErrors": false,
    "useDefineForClassFields": false
  }
}
```



## 2.6 Using WebAssembly

denoå¯ä»¥æ‰§è¡Œ`wasm`äºŒè¿›åˆ¶æ–‡ä»¶

```typescript
const wasmCode = new Uint8Array([
  0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127,
  3, 130, 128, 128, 128, 0, 1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0,
  5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128, 128, 0, 0, 7, 145,
  128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97,
  105, 110, 0, 0, 10, 138, 128, 128, 128, 0, 1, 132, 128, 128, 128, 0, 0,
  65, 42, 11
]);
const wasmModule = new WebAssembly.Module(wasmCode);
const wasmInstance = new WebAssembly.Instance(wasmModule);
console.log(wasmInstance.exports.main().toString());
```

# 3. The Runtime

Runtime functions(web Apis + deco global)

## 3.1 Stability

è‡ª1.0.0ç‰ˆæœ¬åï¼Œå„APIè¶‹äºç¨³å®šï¼Œä½†å¹¶éæ‰€æœ‰çš„APIéƒ½å¯ä»¥æŠ•å…¥prodä½¿ç”¨ï¼Œä½¿ç”¨--unstableè§£é™¤é”å®š

## 3.2 Program lifecycle

denoæ”¯æŒä¸æµè§ˆå™¨å…¼å®¹çš„ç”Ÿå‘½å‘¨æœŸeventsï¼Œ`load` and `unload`

ä½ å¯ä»¥ä½¿ç”¨è¿™äº›eventsï¼Œåœ¨ä½ çš„ç¨‹åºä¸­æä¾› setup/cleanup code

load æ˜¯å¼‚æ­¥çš„ï¼Œç­‰å¾…çš„ï¼Œ**ä¸å¯å–æ¶ˆçš„**

unloadæ˜¯åŒæ­¥çš„ï¼Œ**ä¸å¯å–æ¶ˆçš„**

**main.ts**

```ts
import "./imported.ts";

const handler = (e: Event): void => {
  console.log(`got ${e.type} event in event handler (main)`);
};
window.addEventListener("load", handler);
window.addEventListener("unload", handler);
window.onload = (e: Event): void => {
  console.log(`got ${e.type} event in onload function (main)`);
};
window.onunload = (e: Event): void => {
  console.log(`got ${e.type} event in onunload function (main)`);
};
console.log("log from main script");
```

**imported.ts**

```ts
const handler = (e: Event): void => {
  console.log(`got ${e.type} event in event handler (imported)`);
};

window.addEventListener("load", handler);
window.addEventListener("unload", handler);
window.onload = (e: Event): void => {
  console.log(`got ${e.type} event in onload function (imported)`);
};
window.onunload = (e: Event): void => {
  console.log(`got ${e.type} event in onunload function (imported)`);
};
console.log("log from imported script");
```

run

```shell
$ deno run main.ts
log from imported script
log from main script
got load event in onload function (main)
got load event in event handler (imported)
got load event in event handler (main)
got unload event in onunload function (main)
got unload event in event handler (imported)
got unload event in event handler (main)
```

Importes.tsçš„æ–¹æ³•è¢«mainè¦†ç›–

## 3.3 Compiler APIs

ç›®å‰ç¼–è¯‘å™¨çš„apisæ˜¯unstableçš„ï¼Œdenoæ”¯æŒå¯¹å†…ç½®tsç¼–è¯‘å™¨runtimeçš„è®¿é—®ï¼Œæœ‰ä¸‰ç§æ–¹æ³•è®¿é—®

- Deno.complie()
- Deno.bundle()
- Deno.transpileOnly()

### 3.3.1 Referencing TypeScipt library files



## 3.4 Workers

denoæ”¯æŒweb worker api

workerå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸Šè¿è¡Œä»£ç ï¼Œæ¯ä¸ªworkerå®ä¾‹åœ¨å•ç‹¬ä¸“ç”¨çš„çº¿ç¨‹ä¸Šè¿è¡Œï¼Œç›®å‰ä»…æ”¯æŒ`module`ç±»å‹çš„worker

```typescript
// Good
new Worker("./worker.js", { type: "module" });

// Bad
new Worker("./worker.js");
new Worker("./worker.js", { type: "classic" });
```

### 3.4.1 Permissions

åˆ›å»ºæ–°çš„workeræ˜¯åŠ¨æ€å¯¼å…¥ï¼Œéœ€è¦èµ‹äºˆæƒé™

**main.ts**

```ts
new Worker("./worker.ts", { type: "module" });
```

**worker.ts**

```ts
console.log("hello world");
self.close();
---
$ deno run main.ts
error: Uncaught PermissionDenied: read access to "./worker.ts", run again with the --allow-read flag
$ deno run --allow-read main.ts
hello world
```

For workers using remote modules; `--allow-net` permission is required:

### 3.4.2 Using Deno in worker

**main.js**

```ts
const worker = new Worker("./worker.js", { type: "module", deno: true });
worker.postMessage({ filename: "./log.txt" });
```

**worker.js**

```ts
self.onmessage = async (e) => {
  const { filename } = e.data;
  const text = await Deno.readTextFile(filename);
  console.log(text);
  self.close();
};
```

**log.txt**

```null
hello world
$ deno run --allow-read --unstable main.js
hello world
```

# 4. Linking to external code

# 5. Standard library

# 6. Testing

# 7. Tools

# 8. Embedding Deno

# 9. Contributing

# 10. Examples

